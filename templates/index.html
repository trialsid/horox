<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Horoscope Kiosk</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Arial", sans-serif;
        background-color: #f8f9fa;
        color: #343a40;
        padding: 20px;
      }

      .form-card {
        background-color: #fff;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        padding: 25px;
        max-width: 800px;
        margin: 20px auto;
      }

      .form-card h2 {
        color: #007bff;
        text-align: center;
        margin-bottom: 25px;
        font-size: 2.2rem;
        font-weight: 700;
        text-transform: uppercase;
      }

      .form-control {
        border-radius: 8px;
        border: 2px solid #ced4da;
        padding: 12px;
        font-size: 1.1rem;
      }

      .form-label {
        color: #495057;
        margin-bottom: 8px;
        font-size: 1.1rem;
        font-weight: 600;
      }

      .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
        border-radius: 8px;
        padding: 12px 25px;
        font-weight: 600;
        font-size: 1.1rem;
        width: 100%;
        margin-top: 10px;
      }

      .btn-primary:hover {
        background-color: #0056b3;
        border-color: #0056b3;
        transform: translateY(-2px);
        transition: all 0.3s ease;
      }

      .btn-success {
        background-color: #28a745;
        border-color: #28a745;
        border-radius: 8px;
        padding: 12px 25px;
        font-weight: 600;
        font-size: 1.1rem;
        width: 100%;
        max-width: 300px;
      }

      .btn-success:hover {
        background-color: #1e7e34;
        border-color: #1e7e34;
        transform: translateY(-2px);
        transition: all 0.3s ease;
      }

      .error-message {
        color: #dc3545;
        margin-top: 5px;
        font-weight: 500;
        font-size: 0.9rem;
      }

      #status-container {
        margin-top: 25px;
        padding: 25px;
        border-radius: 15px;
        text-align: center;
        background-color: #fff;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        display: none;
      }

      #text-container {
        margin-top: 20px;
        padding: 20px;
        border-radius: 12px;
        background-color: #f8f9fa;
        font-size: 1.2rem;
        line-height: 1.8;
        text-align: left;
        white-space: pre-wrap;
        font-weight: 500;
      }

      .remaining-count {
        color: #6c757d;
        font-size: 0.9rem;
        font-style: italic;
        margin-top: 8px;
        display: block;
      }

      #playing-message,
      #completed-message {
        font-weight: 700;
        margin-top: 15px;
        font-size: 1.3rem;
        color: #28a745;
      }

      #message-container {
        font-size: 1.4rem;
        font-weight: 700;
        color: #007bff;
        margin-bottom: 15px;
      }

      #total-time {
        margin-top: 15px;
        font-size: 1.1rem;
        font-weight: 600;
        color: #6c757d;
      }

      .button-center {
        display: flex;
        justify-content: center;
        margin-top: 20px;
      }

      @media (max-width: 768px) {
        .form-card {
          padding: 20px;
          margin: 10px;
        }

        .form-card h2 {
          font-size: 1.8rem;
        }

        .form-control,
        .btn-primary,
        .btn-success {
          font-size: 1rem;
          padding: 10px 20px;
        }

        #text-container {
          font-size: 1.1rem;
          padding: 15px;
        }

        #playing-message,
        #completed-message {
          font-size: 1.2rem;
        }

        #message-container {
          font-size: 1.2rem;
        }
      }
    </style>
    <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="form-card" id="form-container">
        <h2 class="mb-4">Horoscope Input Form</h2>
        <form id="horoscopeForm" method="post">
          <div class="mb-3">
            <label for="name" class="form-label">Name:</label>
            <input
              type="text"
              class="form-control"
              id="name"
              name="name"
              required
            />
            <div class="error-message" id="nameError"></div>
          </div>
          <div class="mb-3">
            <label for="place_of_birth" class="form-label"
              >Place of Birth:</label
            >
            <input
              type="text"
              class="form-control"
              id="place_of_birth"
              name="place_of_birth"
              required
            />
            <div class="error-message" id="pobError"></div>
          </div>
          <div class="mb-3">
            <label for="dob" class="form-label">Date of Birth (mm-yyyy):</label>
            <input
              type="text"
              class="form-control"
              id="dob"
              name="dob"
              placeholder="mm-yyyy"
              required
            />
            <div class="error-message" id="dobError"></div>
          </div>
          <div class="mb-3">
            <label for="problem" class="form-label">Problem (Optional):</label>
            <textarea
              class="form-control"
              id="problem"
              name="problem"
            ></textarea>
          </div>
          <div class="mb-3">
            <label for="occupation" class="form-label"
              >Occupation (Optional):</label
            >
            <input
              type="text"
              class="form-control"
              id="occupation"
              name="occupation"
            />
          </div>
          <button type="submit" class="btn btn-primary">
            Generate Horoscope
          </button>
        </form>
      </div>
    </div>
    <div class="container">
      <div id="status-container">
        <div id="message-container"></div>
        <div id="text-container"></div>
        <div id="playing-message" style="display: none">
          Horoscope playing...
        </div>
        <div id="completed-message" style="display: none"></div>
        <div
          id="error-message-speech"
          class="error-message"
          style="display: none"
        ></div>
        <div id="total-time" style="display: none"></div>
        <div class="button-center">
          <button id="new-start-btn" class="btn btn-success" style="display: none" onclick="resetForm()">
              Start New
          </button>
      </div>
          Start New
        </button>
      </div>
    </div>
    <script>
      function resetForm() {
        document.getElementById("form-container").style.display = "block";
        document.getElementById("horoscopeForm").reset();
        // Clear error messages
        document.getElementById("nameError").textContent = "";
        document.getElementById("pobError").textContent = "";
        document.getElementById("dobError").textContent = "";
        document.getElementById("message-container").textContent = "";
        document.getElementById("text-container").textContent = "";
        document.getElementById("status-container").style.display = "none";
        document.getElementById("playing-message").style.display = "none";
        document.getElementById("completed-message").style.display = "none";
        document.getElementById("error-message-speech").style.display = "none";
        document.getElementById("total-time").style.display = "none";
        document.getElementById("new-start-btn").style.display = "none";
      }

      document
        .getElementById("horoscopeForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          document.getElementById("form-container").style.display = "none";

          // Reset all messages and displays
          document.getElementById("nameError").textContent = "";
          document.getElementById("pobError").textContent = "";
          document.getElementById("dobError").textContent = "";
          document.getElementById("message-container").textContent = "";
          document.getElementById("text-container").textContent = "";
          document.getElementById("status-container").style.display = "block";
          document.getElementById("playing-message").style.display = "none";
          document.getElementById("completed-message").style.display = "none";
          document.getElementById("error-message-speech").style.display =
            "none";
          document.getElementById("total-time").style.display = "none";
          document.getElementById("new-start-btn").style.display = "none";

          let isValid = true;

          // Form validation
          const nameInput = document.getElementById("name");
          if (!nameInput.value.trim()) {
            document.getElementById("nameError").textContent =
              "Name is required.";
            isValid = false;
          }

          const pobInput = document.getElementById("place_of_birth");
          if (!pobInput.value.trim()) {
            document.getElementById("pobError").textContent =
              "Place of Birth is required.";
            isValid = false;
          }

          const dobInput = document.getElementById("dob");
          const dobRegex = /^(0[1-9]|1[0-2])-\d{4}$/;
          if (!dobInput.value.trim()) {
            document.getElementById("dobError").textContent =
              "Date of Birth is required.";
            isValid = false;
          } else if (!dobRegex.test(dobInput.value)) {
            document.getElementById("dobError").textContent =
              "Invalid date format. Use mm-yyyy.";
            isValid = false;
          }

          // At the start of form submission after validation passes
          if (isValid) {
            // Hide form
            document.getElementById("form-container").style.display = "none";

            // Show status container with initial "generating" message
            document.getElementById("status-container").style.display = "block";
            document.getElementById("message-container").textContent =
              "Generating horoscope...";

            // Ensure other elements are hidden initially
            document.getElementById("playing-message").style.display = "none";
            document.getElementById("completed-message").style.display = "none";
            document.getElementById("error-message-speech").style.display =
              "none";
            document.getElementById("total-time").style.display = "none";
            document.getElementById("new-start-btn").style.display = "none";

            // Continue with fetch...
            // Update the fetch handling in the form submit event listener
            fetch("/", {
              method: "POST",
              body: new FormData(event.target),
            })
              .then((response) => {
                if (!response.ok) {
                  return response.json().then((err) => {
                    throw new Error(JSON.stringify(err));
                  });
                }
                return response.json();
              })
              // In the fetch handling code
              .then((data) => {
                if (data.error) {
                  throw new Error(data.error);
                }

                // Truncate text and show remaining count
                const fullText = data.fullText;
                const truncatedText = fullText.slice(0, 75) + "...";
                const remainingCount = fullText.length - 75;

                const textContainer = document.getElementById("text-container");
                textContainer.innerHTML = truncatedText;

                if (remainingCount > 0) {
                  const remainingCountElement = document.createElement("span");
                  remainingCountElement.className = "remaining-count";
                  remainingCountElement.textContent = `${remainingCount} more characters`;
                  textContainer.appendChild(remainingCountElement);
                }

                // Show playing message
                document.getElementById("playing-message").style.display =
                  "block";

                // Wait 60 seconds before starting to check status
                setTimeout(() => {
                  let checkCount = 0;
                  const maxChecks = 30; // Maximum number of checks (1 minute with 2-second interval)

                  function checkSpeechStatus() {
                    checkCount++;
                    fetch("/speech_status")
                      .then((response) => response.json())
                      .then((statusData) => {
                        if (statusData.completed || checkCount >= maxChecks) {
                          // Speech is done or we've reached max checks
                          document.getElementById(
                            "playing-message"
                          ).style.display = "none";

                          if (
                            statusData.completed &&
                            statusData.startTime &&
                            statusData.endTime
                          ) {
                            document.getElementById(
                              "completed-message"
                            ).textContent = "Completed";
                            document.getElementById(
                              "completed-message"
                            ).style.display = "block";

                            const totalTime =
                              (new Date(statusData.endTime) -
                                new Date(statusData.startTime)) /
                              1000;
                            document.getElementById(
                              "total-time"
                            ).textContent = `Total Time: ${totalTime.toFixed(
                              2
                            )} seconds`;
                            document.getElementById(
                              "total-time"
                            ).style.display = "block";
                          } else {
                            document.getElementById(
                              "completed-message"
                            ).textContent = "Playback finished";
                            document.getElementById(
                              "completed-message"
                            ).style.display = "block";
                          }

                          document.getElementById(
                            "new-start-btn"
                          ).style.display = "block";
                        } else if (checkCount < maxChecks) {
                          // Check again in 2 seconds
                          setTimeout(checkSpeechStatus, 2000);
                        }
                      })
                      .catch((error) => {
                        console.error("Error checking status:", error);
                        // Stop checking on error
                        document.getElementById(
                          "playing-message"
                        ).style.display = "none";
                        document.getElementById(
                          "completed-message"
                        ).textContent = "Playback finished";
                        document.getElementById(
                          "completed-message"
                        ).style.display = "block";
                        document.getElementById("new-start-btn").style.display =
                          "block";
                      });
                  }

                  // Start checking status after 60 seconds
                  checkSpeechStatus();
                }, 60000);
              })
              .catch((error) => {
                console.error("Error:", error);
                document.getElementById("message-container").textContent =
                  "An error occurred. Please try again.";
                document.getElementById("form-container").style.display =
                  "block";
                document.getElementById("status-container").style.display =
                  "none";
              });
          } else {
            document.getElementById("message-container").textContent =
              "Please fix the errors and try again.";
            document.getElementById("form-container").style.display = "block";
            document.getElementById("status-container").style.display = "none";
          }
        });
    </script>


<div class="button-center" style="margin-bottom: 20px;">
  <button onclick="startAudioStream()" class="btn btn-primary" id="audio-start-btn">
      Start Audio Stream
  </button>
</div>

<script>
  // Audio context setup
  let audioContext;
  let audioQueue = [];
  const socket = io();

  async function startAudioStream() {
      try {
          const response = await fetch('/start_audio', {
              method: 'POST'
          });
          const data = await response.json();
          
          if (data.status === 'success') {
              document.getElementById('audio-start-btn').disabled = true;
              document.getElementById('audio-start-btn').textContent = 'Audio Stream Active';
              initAudio();
          } else {
              alert('Failed to start audio stream: ' + data.message);
          }
      } catch (error) {
          console.error('Error:', error);
          alert('Error starting audio stream');
      }
  }

  function initAudio() {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }

  socket.on('audio_stream', function(data) {
      if (!audioContext) {
          initAudio();
      }
      
      // Convert received data to audio buffer and play
      const audioData = new Float32Array(data.audio);
      const buffer = audioContext.createBuffer(1, audioData.length, 44100);
      buffer.copyToChannel(audioData, 0);

      const source = audioContext.createBufferSource();
      source.buffer = buffer;
      source.connect(audioContext.destination);
      source.start();
  });
</script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
